---
title: "R Notebook"
output: html_notebook
---

# Unit 1: Intro to Analytics 

## Getting Started in R

```{r}
# Get help on functions
?sqrt

# Get a list of vars in env
ls()
```


## Vectors and DataFrames

```{r}
# Create a vector using c function
country <- c("Brazil", "China", "India", "Switzerland", "USA")
LifeExpectancy <- c(74, 76, 65, 83, 79)

# To display an element of a vec, use [ ]
country[3]

# To create a sequence, use seq
seq(0,100,2)

# Combine vecs into a df structure
CountryData <- data.frame(country, LifeExpectancy)
CountryData

# Now, add a var to this df. Use a $ to link the data
CountryData$Population <- c(199000,1390000, 1240000,7997,318000)

CountryData

# Now, add 2 new countries: Aus and Grc. 
country <- c("Australia", "Greece")
LifeExpectancy <- c(82,81)
Population <- c(23050,11125)

NewCountryData <- data.frame(country, LifeExpectancy, Population)
NewCountryData

# Now, combine CountryData and NewCountryData
AllCountryData <- rbind(CountryData, NewCountryData)
AllCountryData
```

## Loading Data Files

```{r}
getwd()
WHO <- read.csv("WHO.csv")
str(WHO)

summary(WHO)

# Subsetting data to include only countries in EU
?subset
WHO_Europe <- subset(WHO,Region = "Europe")
WHO_Europe

# Now, remove WHO_Europe from environment
rm(WHO_Europe)
ls()

```

## Data Analysis - Summary Stats and Scatterplots

```{r}
mean(WHO$Under15)
sd(WHO$Under15)
summary(WHO$Under15)  #13.12% of pop is under 15 (min) - which one is it?  Japan!
WHO$Country[which.min(WHO$Under15)]

# Which country has max under 15? Niger with 49.99!
WHO$Country[which.max(WHO$Under15)]

# Create a scatterplot of GNI vs. fertility rate
plot(WHO$GNI, WHO$FertilityRate)

# look at countries with a GNI > 10,000 and Fertility Rate > 2.5
outliers <- subset(WHO, GNI > 10000 & FertilityRate > 2.5)
nrow(outliers)

outliers[c("Country", "GNI", "FertilityRate")]

# What is the mean value of WHO$Over60? 11.16366
mean(WHO$Over60)

# Which country has the smallest % of pop over 60?
WHO$Country[which.min(WHO$Over60)]

# which country has the largest literacy rate?
WHO$Country[which.max(WHO$LiteracyRate)]

```

## Data Analysis - Plots and Summary Tables

IQR = Difference between 1st and 3rd quartiles  
Any point that is > 3rd quartile + IQR or < 1st quartile - IQR is an outlier.

1. EU has highest median life expectancy.  
2. Americas has the smallest IQR.  
3. Eastern Mediterranean has the highest overall range of life expectancy.  



```{r}
# Histograms

hist(WHO$CellularSubscribers)

# Boxplot

boxplot(WHO$LifeExpectancy~WHO$Region)

#  Add labels
boxplot(WHO$LifeExpectancy~WHO$Region, xlab = "", ylab = "Life Expectancy", main = "Life Expectancy of Countries by Region")

# Summary Tables

table(WHO$Region)

# tapply...splits data by 2nd arg, then applies the 3rd to the var given as 1st. Take the mean of those > 60 by region.

tapply(WHO$Over60, WHO$Region, mean)

tapply(WHO$LiteracyRate, WHO$Region, min, na.rm=T)

# Use tapply to find the average child mortality rate of countries in each region.
tapply(WHO$ChildMortality, WHO$Region, mean)

```

## Recitation 1 - Nutrition
In 1990, all states had < 14% obesity. By 2000, half of the country had > 20% of its population obese.  By 2010, all states had > 20% of its population obese.

```{r}
USDA <- read.csv("USDA.csv")
str(USDA)
summary(USDA)

# The max of sodium is very high, which value does it correspond to?
USDA$Description[which.max(USDA$Sodium)]

# Which foods contain > 10,000 mg of sodium?
HighSodium <- subset(USDA, Sodium > 10000)
nrow(HighSodium)
HighSodium$Description

# How much salt does caviar have? 1500
USDA$Sodium[match("CAVIAR", USDA$Description)]

# Compare Caviar to mean and sd across dataset. Mean sodium = 322.1, SD Sodium= 1045.417
# 322 + 1045 = 1367 -> caviar is > 1 SD above the mean
summary(USDA$Sodium)
sd(USDA$Sodium, na.rm = T)

## Creating Plots in R 

# Create a scatterplot w/ Protien on the x-axis and Fat on the y-axis
plot(USDA$Protein, USDA$TotalFat, xlab="Protien", ylab= "Total Fat", main = "Protien vs Fat", col = "blue")

# Create a hist of Vitamin C
hist(USDA$VitaminC, main = "Histogram of Vitamin C Levels")

# Need to zoom in on < 100mg

hist(USDA$VitaminC, main = "Histogram of Vitamin C Levels", xlim = c(0,100))

# Now, break up into 100 increments.  We only see 5 cells and each cell is 20mg?  Original went to 2000mg.  2000mg/100 = 20mg
?hist
hist(USDA$VitaminC, main = "Histogram of Vitamin C Levels", xlim = c(0,100), breaks = 100)

# let's get to 100 breaks
hist(USDA$VitaminC, main = "Histogram of Vitamin C Levels", xlim = c(0,100), breaks = 2000, col = "pink")

# boxplot for sugar
boxplot(USDA$Sugar, main = "Boxplot of Sugar Levels", ylab = "Sugar in grams")

# Adding variables 
# Add a 1 if food is higher than sodium avg and 0 if less than sodium average
USDA$Sodium[1] > mean(USDA$Sodium, na.rm = T)
USDA$Sodium[50] > mean(USDA$Sodium, na.rm = T)
USDA$HighSodium <- as.numeric(USDA$Sodium > mean(USDA$Sodium, na.rm = TRUE))
str(HighSodium)
USDA$HighProtien <- as.numeric(USDA$Protein > mean(USDA$Protein, na.rm = TRUE))
USDA$HighFat <- as.numeric(USDA$TotalFat > mean(USDA$TotalFat, na.rm = TRUE))
USDA$HighCarbs <- as.numeric(USDA$Carbohydrate > mean(USDA$Carbohydrate, na.rm = TRUE))
str(USDA)

# Summary Tables
## Now, figure out how many foods have a higher sodium level than average
table(USDA$HighSodium)

## Now, how many have High Sodium and High Fat? Rows are first input, cols are second
table(USDA$HighSodium, USDA$HighFat)

## Now, what if wanted avg amount of Iron sorted by Hi and Lo protien? NEED TAPPLY? WHY?
## tapply Groups arg 1 by arg 2 and applies arg 3

tapply(USDA$Iron, USDA$HighProtien, mean, na.rm = TRUE)

## What is the max level of Vitamin C in foods with Hi and Lo carbs?
tapply(USDA$VitaminC, USDA$HighCarbs, max, na.rm = TRUE)

## is it true that foods high in carbs have a high vitamin C content? Yes, on average
tapply(USDA$VitaminC, USDA$HighCarbs, summary, na.rm = TRUE)

```


## HW - An Analytical Detective

```{r}
mvt <- read.csv("mvtWeek1.csv")

#How many rows?
str(mvt)

#Max of ID?
max(mvt$ID)

# Min of beat?
min(mvt$Beat)

# How many T arrest var?
summary(mvt$Arrest)

# How many have location == alley?
sum(mvt$LocationDescription == "ALLEY")
```

### Dates in R


```{r}
# Look at the first date in Date....Month/Day/Year 24Hour:Minute
mvt$Date[1]

# Convert chars into a date object in R for Date col into DateConvert col
DateConvert <- as.Date(strptime(mvt$Date, "%m/%d/%y %H:%M"))
summary(DateConvert)

# Now, let's create two new variables in our dataframe, Month and Weekday
mvt$Month <- months(DateConvert)
mvt$Weekday <- weekdays(DateConvert)
mvt$Date <- DateConvert

# In which month did the fewest motor vehicle thefts occur?
table(mvt$Month)

# Which weekday had the most?
table(mvt$Weekday)

# Which month has the largest number of mvt for which an arrest was made?
summary(mvt$Arrest)
table(mvt$Arrest, mvt$Month)
```


### Visualizing Crime Trends

```{r}
# Does crime increase or decrease from 2002 - 2012?
hist(mvt$Date, breaks=100)

# Create a boxplot of Date sorted by Arrest (YIKES!)
?boxplot
boxplot(mvt$Date ~ mvt$Arrest)

# If you look at the boxplot, the one for Arrest=TRUE is definitely skewed towards the bottom of the plot

# For what proportion of motor vehicle thefts in 2001 was an arrest made? Value btw 0 and 1
# Arrest = T / all incidents in 2001
table(mvt$Arrest, mvt$Year)
2152/(2152+18517) #2001
1212/(13068+1212) #2007
550/(13542+550) #2012

```


```{r}
# Popular locations

## If Chi wants to increase # of arrests, where should they focus?
## Create a table of LocationDescription using sort
sort(table(mvt$LocationDescription), decreasing = TRUE)

## Popular locations
Top5 <- subset(mvt, LocationDescription == "STREET" | LocationDescription == "PARKING LOT/GARAGE(NON.RESID.)" | LocationDescription == "ALLEY" | LocationDescription == "GAS STATION" | LocationDescription == "DRIVEWAY - RESIDENTIAL")
nrow(Top5)

## Refresh

Top5$LocationDescription <- factor(Top5$LocationDescription)
str(Top5)

# Which location has higher arrest rate than others?

table(Top5$Arrest, Top5$LocationDescription)

# Which day of the week do most mvt at gas stations happen?
table(Top5$Weekday,Top5$LocationDescription == "GAS STATION")

# Which day of the week do FEWEST mvt at DRIVEWAYs happen?
table(Top5$Weekday,Top5$LocationDescription == "DRIVEWAY - RESIDENTIAL")
```


```{r}
# Stock Dynamics
IBM <- read.csv("IBMStock.csv")
GE <- read.csv("GEStock.csv")
ProcterGamble <- read.csv("ProcterGambleStock.csv")
CocaCola <- read.csv("CocaColaStock.csv")
Boeing <- read.csv("BoeingStock.csv")

# Convert Date field into something R understands
IBM$Date = as.Date(IBM$Date, "%m/%d/%y")
GE$Date = as.Date(GE$Date, "%m/%d/%y")
CocaCola$Date = as.Date(CocaCola$Date, "%m/%d/%y")
ProcterGamble$Date = as.Date(ProcterGamble$Date, "%m/%d/%y")
Boeing$Date = as.Date(Boeing$Date, "%m/%d/%y")

# How many observations are there?
nrow(IBM)

# What is the earliest year?
min(IBM$Date)
min(Boeing$Date)

# Latest year?
max(IBM$Date)

# Mean IBM price?
mean(IBM$StockPrice)

# Min GE price?
min(GE$StockPrice)

# Max Coke price?
max(CocaCola$StockPrice)

# Median Boeing?
summary(Boeing)

# SD of P&G?
sd(ProcterGamble$StockPrice)

```


### Visualizing Stock Dynamics

```{r}
# Plot Coke - Date on x-axis, price on y-axis using a line
plot(CocaCola$Date, CocaCola$StockPrice, type = "l", col = "red")

# Now, add P&G to Coke
lines(ProcterGamble$Date, ProcterGamble$StockPrice, col = "blue")
abline(v=as.Date(c("1983-03-01")), lwd=1)


# Changes from 95 to 2005. Use lines function to add other companies
plot(CocaCola$Date[301:432], CocaCola$StockPrice[301:432], type="l", col="red", ylim=c(0,210))
lines(ProcterGamble$Date, ProcterGamble$StockPrice, col = "blue")
lines(IBM$Date, IBM$StockPrice, col = "black")
lines(Boeing$Date, Boeing$StockPrice, col = "green")
lines(GE$Date, GE$StockPrice, col = "orange")
abline(v=as.Date(c("2004-01-01")), lwd=1)
abline(v=as.Date(c("2005-11-30")), lwd=1)


## Monthly trends
## Calculate the mean price of IBM sorted by month using tapply

## tapply Groups arg 1 by arg 2 and applies arg 3

tapply(IBM$StockPrice, months(IBM$Date), mean, na.rm = TRUE)
mean(IBM$StockPrice)


## Repeat above for Coke
tapply(CocaCola$StockPrice, months(CocaCola$Date), mean, na.rm = TRUE)
mean(CocaCola$StockPrice)

tapply(GE$StockPrice, months(GE$Date), mean, na.rm = TRUE)
60.02973
```

```{r}
## Demographics and Employment in the United States
## How many interviewees are in the dataset?

CPS <- read.csv("CPSData.csv")
nrow(CPS)

## What is most common industry of employment?  Try sorting!
  
str(CPS)
sort(table(CPS$Industry),decreasing = TRUE)


## Which state has the fewest interviewees?

sort(table(CPS$State), decreasing = TRUE)

## What PROPORTION of interviewees are US citizens?

table(CPS$Citizenship)
(116639+7073)/nrow(CPS)

## For which races are there at least 250 interviewees in the CPS dataset of Hispanic ethnicity?

table(CPS$Hispanic, CPS$Race)

## Which variables have at least one interviewee with a missing (NA) value? (Select all that apply.)
summary(CPS)

## Is there a pattern in missing values?  Is Married based upon region?
table(CPS$Region, is.na(CPS$Married))
table(CPS$Sex, is.na(CPS$Married))
table(CPS$Age, is.na(CPS$Married))

### Region
6075/(24609+6075)
4507/(21432+4507)
7967/(33535+7967)
6789/(26388+6789)

### Sex
12217/(12217+55264)
13121/(13121+50700)

## MetroCode is N/A if interviewee does not live in a metro area. 
## How many states had all interviewees living in a non-metro area (missing metro area)
table(is.na(CPS$MetroAreaCode), CPS$State)

## Which region has largest proportion living in a non-metro area?
table(is.na(CPS$MetroAreaCode), CPS$Region)

## Less tedious way to calculate proportions that are TRUE!  Mean returns proportion of values that are TRUE!
sort(tapply(is.na(CPS$MetroAreaCode), CPS$State, mean), decreasing = TRUE)

## Read in 2 dictionaries
MetroAreaMap <- read.csv("MetroAreaCodes.csv")
str(MetroAreaMap)

CountryMap <- read.csv("CountryCodes.csv")
str(CountryMap)


## Merge and overwrite the CPS df

CPS = merge(CPS, MetroAreaMap, by.x="MetroAreaCode", by.y="Code", all.x=TRUE)

## What is the name of the new var that was added to CPS?
summary(CPS)
str(CPS)

## How many interviewees have a missing value for the new MetroArea variable?
table(is.na(CPS$MetroArea))

## Which metro area has the largest # of interviewees?
sort(table(CPS$MetroArea), decreasing = TRUE)

## Which  metro area has the > proportion of Hispanics?
sort(tapply(CPS$Hispanic, CPS$MetroArea, mean, na.rm = TRUE), decreasing = TRUE)

##  determine the number of metropolitan areas in the United States from which at least 20% of interviewees are Asian.
sort(tapply(CPS$Race == "Asian", CPS$MetroArea, mean, na.rm = TRUE), decreasing = TRUE)

##  determine which metropolitan area has the smallest proportion of interviewees who have received no high school diploma

sort(tapply(CPS$Education == "No high school diploma", CPS$MetroArea, mean, na.rm = TRUE), decreasing = FALSE)


## merge in the country of birth information from the CountryMap data frame
CPS <- merge(CPS, CountryMap, by.x="CountryOfBirthCode", by.y="Code", all.x=TRUE)

## How many interviewees have a missing value for the new country of birth variable?
table(is.na(CPS$Country))

## Which country outside of NA was most common?
sort(table(CPS$Country), decreasing = TRUE)

## What proportion of the interviewees from the "New York-Northern New Jersey-Long Island, NY-NJ-PA" metropolitan area have a country of birth that is not the United States?

#table(subset(CPS, Country == "United States"), subset(CPS, MetroArea == "New York-Northern New Jersey-Long Island, NY-NJ-PA"))

####  table(CPS$MetroArea == "New York-Northern New Jersey-Long Island, NY-NJ-PA", CPS$Country != "United States")

MetroNJ <- subset(CPS, MetroArea == "New York-Northern New Jersey-Long Island, NY-NJ-PA")
head(MetroNJ)

table(MetroNJ$Country == "United States")

1668/nrow(MetroNJ)

## Which metropolitan area has the largest number (note -- not proportion) of interviewees with a country of birth in India? 

###To obtain the number of TRUE values in a vector of TRUE/FALSE values, you can use the sum() function. For instance, sum(c(TRUE, FALSE, TRUE, TRUE)) is 3. Therefore, we can obtain counts of people born in a particular country living in a particular metropolitan area with:
sort(tapply(CPS$Country == "India", CPS$MetroArea, sum, na.rm=TRUE))
sort(tapply(CPS$Country == "Brazil", CPS$MetroArea, sum, na.rm=TRUE))
sort(tapply(CPS$Country == "Somalia", CPS$MetroArea, sum, na.rm=TRUE))
We see that New York has the most interviewees born in India (96), Boston has the most born in Brazil (18), and Minneapolis has the most born in Somalia (17). 

```


This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.